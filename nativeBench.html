<!DOCTYPE html>
<html>
    <body>
        <p>working</p>
        <script src="https://cdn.jsdelivr.net/npm/gmp-wasm/dist/mini.umd.min.js"></script>
        <script>
            
            function collatz(numberPtrOg,binding){
                const numberPtr=binding.mpz_t();
                binding.mpz_add(numberPtr,numberPtrOg,makeInt(0,binding));
                const three=makeInt(3,binding);
                const one = makeInt(1,binding);
                const two=makeInt(2,binding);
                const count = makeInt(1,binding);
                //console.log([binding.mpz_to_string(numberPtr,10),binding.mpz_cmp_ui(numberPtr,one)]);
                while(binding.mpz_cmp_ui(numberPtr,1)>0){
                    //console.log(binding.mpz_to_string(numberPtr,10));
                    if(binding.mpz_tstbit(numberPtr,0)){
                        binding.mpz_mul(numberPtr,numberPtr,three);
                        binding.mpz_add(numberPtr,numberPtr,one);
                    }else{
                        binding.mpz_divexact(numberPtr,numberPtr,two);
                    }
                    binding.mpz_add(count,count,one);
                }
                //binding.mpz_clears(numberPtr);
                binding.mpz_t_frees(numberPtr);
                return binding.mpz_to_string(count,10);
            }
            async function testCollatz(iters){
                await gmp.init().then(({binding})=>{
                    console.log('starting collatz test')
                    const gstart=makeMersenneLow(1000,binding);
                    let two = makeInt(2,binding);
                    let totalTime=0;
                    for(let i =0;i<iters;++i){
                        let startTime=Date.now();
                        let res=collatz(gstart,binding);
                        //console.log(res)
                        let elapsed=Date.now()-startTime;
                        totalTime+=elapsed;
                        binding.mpz_add(gstart,gstart,two);
                        
                    }
                    console.log(`${iters} iters of collatz testing took ${totalTime}, avg ${totalTime/iters} per iteration`);
                    binding.reset();
                })
            }
            function lucasLehmer(p,binding){
                const mersenne= makeMersenneLow(p,binding);
                const s = makeInt(4,binding);
                const two=makeInt(2,binding)
                for(var i=0;i<p-2;++i){
                    binding.mpz_mul(s,s,s);
                    binding.mpz_add(s,s,two);
                    binding.mpz_mod(s,s,mersenne);
                }
                return binding.mpz_get_si(s)==0;//true means prime
            }
            function singleMillerRabinGMPLow(numberPtr,s,d,binding){//all inputs are pointers
                //gmp.init().then(({binding})=>{
                    //console.log(binding)
                    const a = makeInt(2+Math.floor(Math.random()*(binding.mpz_get_si(numberPtr)-3)),binding);
                    const start = binding.mpz_t();
                    const minus1=binding.mpz_t();
                    const one = makeInt(1,binding);
                    binding.mpz_sub(minus1,numberPtr,one);
                    const actualMinus1=binding.mpz_get_si(minus1)
                    binding.mpz_powm(start,a,d,numberPtr);
                    let r=binding.mpz_get_si(start);
                    if(r==1 || r==actualMinus1){
                        return true;
                    }
                    const two = makeInt(2,binding);
                    for(let i=0;i<binding.mpz_get_si(s);++i){
                        binding.mpz_powm(start,start,two,numberPtr);
                        if(binding.mpz_cmp_ui(start,actualMinus1)==0){
                            return true;
                        }
                    }
                    //binding.mpz_t_frees(actualMinus1,start,a,one)
                    return false;
                //})
            }
            function millerRabinGMPLow(numberPtr,iters, binding){//number should also be pointer
                //console.log(binding)
                let s=0;
                const d=binding.mpz_t();
                const one=makeInt(1,binding);
                binding.mpz_sub(d,numberPtr,one);
                const two = makeInt(2,binding);
                while(binding.mpz_tstbit(d,0)){//bitcnt might just be a js number
                    binding.mpz_divexact(d,d,two);
                    s++;
                }
                const sp=makeInt(s,binding);
                for(let i=0;i<iters;++i){
                    if(!singleMillerRabinGMPLow(numberPtr,sp,d,binding)){
                        return false;
                    }
                }
                //binding.mpz_t_frees(d,two,one)
                return true;
            }
            
            async function testPrimeFull(iters){
                await gmp.init().then(({binding})=>{
                    console.log("starting prime test")
                    const start=makeMersenneLow(3217,binding);//3217
                    let totalTime=0;
                    const two=makeInt(2,binding);
                    for(let i=0;i<iters;++i){
                        let startTime=Date.now();
                        millerRabinGMPLow(start,10,binding);
                        let elapsed=Date.now()-startTime;
                        totalTime+=elapsed;
                        binding.mpz_add(start,start,two);
                        
                    }
                    console.log(`${iters} iters of miller rabin testing took ${totalTime}, avg ${totalTime/iters} per iteration`);
                    binding.reset()
                })
                
            }
            function gmpProbablePrime(number,iters){
                return gmp.init().then(({calculate})=>{
                    return calculate(g=>{
                        var num = g.Integer(number.toString());
                        var result= num.isProbablyPrime(iters);
                        mappings ={
                            false: 0,
                            'probably prime':1,
                            true:2
                        };
                        return mappings[result];
                    })
                });
            }
            function makeMersenneLow(p,binding){
                const start=makeInt(1,binding);
                const one = makeInt(1,binding)
                binding.mpz_mul_2exp(start,start,p);
                binding.mpz_sub(start,start,one);
                return start;//pointer
            }
            function makeInt(val,binding){
                const result = binding.mpz_t();
                binding.mpz_init_set_si(result,val);
                return result;
            }
            
            function sleep(ms){
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            async function sleepBench(iters, delay){
                console.log('starting sleep bench')
                let start=Date.now();
                for(let i=0;i<iters;++i){
                    await sleep(delay);
                }
                let elapsed=Date.now()-start;
                console.log(`sleep test took ${elapsed} overall, average of ${elapsed/iters}`);
            }
            async function mainLoop(){
                //await testPrimeFull(10);
                //await testCollatz(1000);
                await testPrimeFull(32);
                //await sleepBench(32,1100);
                //await simpleBench(async function mr(){await testMillerRabinGMPLow(3253,10)},1);
                //await simpleBench(async function tc(){await testCollatz(200000,10000)},1)
            }
            mainLoop()
        </script>
    </body>
</html>